name: conformance
# web-visible: true (see operational/WEB_VISIBLE_POLICY.md)

on:
  pull_request:
  push:
    branches:
      - main

permissions:
  contents: read
  packages: read

jobs:
  cv-sighash-strict:
    name: CV-SIGHASH (strict wolfcrypt)
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install oras
        uses: oras-project/setup-oras@v1

      - name: Install cosign
        uses: sigstore/cosign-installer@v3
        with:
          cosign-release: "v2.2.2"

      - name: Login to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | oras login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Fetch wolfcrypt shim (verify cosign + hash pin)
        id: shim
        env:
          REF: ghcr.io/${{ github.repository_owner }}/wolfcrypt-shim:ubuntu-22.04-gcc-12
        run: |
          chmod +x ./crypto/wolfcrypt/fetch_shim_from_ghcr.sh
          chmod +x ./crypto/wolfcrypt/verify_shim_cosign.sh
          exports="$(./crypto/wolfcrypt/fetch_shim_from_ghcr.sh "${REF}" /tmp/rubin-wolfcrypt-shim --export-env)"
          echo "${exports}"
          eval "${exports}"
          echo "RUBIN_WOLFCRYPT_SHIM_PATH=${RUBIN_WOLFCRYPT_SHIM_PATH}" >> "${GITHUB_ENV}"
          echo "RUBIN_WOLFCRYPT_SHIM_SHA3_256=${RUBIN_WOLFCRYPT_SHIM_SHA3_256}" >> "${GITHUB_ENV}"
          echo "RUBIN_WOLFCRYPT_STRICT=1" >> "${GITHUB_ENV}"

          shim_dir="$(dirname "${RUBIN_WOLFCRYPT_SHIM_PATH}")"
          if ldd "${RUBIN_WOLFCRYPT_SHIM_PATH}" | grep -q "libwolfssl.so.44 => not found"; then
            echo "Downloaded shim still requires external libwolfssl; rebuilding local shim as fallback."
            chmod +x ./scripts/wolfcrypt-build.sh
            ./scripts/wolfcrypt-build.sh
            local_shim="/tmp/rubin-wolfcrypt/wolfcrypt-shim/librubin_wc_shim.so"
            if [ ! -f "${local_shim}" ]; then
              echo "local fallback shim not found: ${local_shim}" >&2
              exit 1
            fi
            local_shim_sha="$(python3 -c 'import hashlib, pathlib; print(hashlib.sha3_256(pathlib.Path("/tmp/rubin-wolfcrypt/wolfcrypt-shim/librubin_wc_shim.so").read_bytes()).hexdigest())')"
            echo "RUBIN_WOLFCRYPT_SHIM_PATH=${local_shim}" >> "${GITHUB_ENV}"
            echo "RUBIN_WOLFCRYPT_SHIM_SHA3_256=${local_shim_sha}" >> "${GITHUB_ENV}"
            echo "RUBIN_WOLFCRYPT_STRICT=1" >> "${GITHUB_ENV}"
            shim_dir="$(dirname "${local_shim}")"
          fi

      - name: Install runner deps
        run: python3 -m pip install --upgrade pip pyyaml

      - name: Run CV-SIGHASH strict
        env:
          RUBIN_CONFORMANCE_RUST_NO_DEFAULT: "1"
          RUBIN_CONFORMANCE_RUST_FEATURES: "wolfcrypt-dylib"
          RUBIN_CONFORMANCE_GO_TAGS: "wolfcrypt_dylib"
          RUBIN_WOLFCRYPT_STRICT: "1"
          RUBIN_WOLFCRYPT_SHIM_PATH: ${{ env.RUBIN_WOLFCRYPT_SHIM_PATH }}
          RUBIN_WOLFCRYPT_SHIM_SHA3_256: ${{ env.RUBIN_WOLFCRYPT_SHIM_SHA3_256 }}
        run: |
          shim_dir="$(dirname "${RUBIN_WOLFCRYPT_SHIM_PATH}")"
          export LD_LIBRARY_PATH="${shim_dir}:${LD_LIBRARY_PATH-}"
          python3 conformance/runner/run_cv_sighash.py
