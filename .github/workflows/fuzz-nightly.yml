name: fuzz-nightly

on:
  schedule:
    - cron: "20 3 * * *"
  workflow_dispatch:
    inputs:
      fuzz_time:
        description: "Go fuzz time per target (for example 45s, 120s)"
        required: false
        default: "45s"

concurrency:
  group: fuzz-nightly-${{ github.ref }}
  cancel-in-progress: false

jobs:
  fuzz-stage2:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-go@v5
        with:
          go-version: '1.24.13'
          cache: true
          cache-dependency-path: clients/go/go.mod

      - name: Run stage2 fuzz targets (timeboxed)
        env:
          FUZZ_TIME: ${{ github.event.inputs.fuzz_time || '45s' }}
          FUZZ_MINIMIZE_TIME: "5s"
        run: |
          scripts/dev-env.sh -- bash -lc 'cd "$GITHUB_WORKSPACE" && scripts/ci/run_fuzz_stage2.sh'

      - name: Upload fuzz artifacts (crashes/regressions)
        if: always()
        uses: actions/upload-artifact@v7
        with:
          name: fuzz-stage2-${{ github.run_id }}
          path: |
            .artifacts/fuzz-stage2/**
            clients/go/consensus/testdata/fuzz/**
          if-no-files-found: warn
          retention-days: 14
