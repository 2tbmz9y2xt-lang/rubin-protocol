name: codacy-coverage
on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.24.13'
          cache: true
          cache-dependency-path: clients/go/go.mod

      - uses: dtolnay/rust-toolchain@stable

      - name: Go coverage
        run: |
          cd clients/go
          go test -coverprofile=coverage.out ./...

      - name: Rust coverage
        run: |
          cargo install cargo-tarpaulin --locked
          cd clients/rust
          cargo tarpaulin --out Lcov --output-dir .

      - name: Upload to Codacy
        env:
          CODACY_API_TOKEN: ${{ secrets.CODACY_API_TOKEN }}
          CODACY_ORGANIZATION_PROVIDER: gh
          CODACY_USERNAME: ${{ github.repository_owner }}
          CODACY_PROJECT_NAME: rubin-protocol
          CODACY_COMMIT_UUID: ${{ github.event.pull_request.head.sha || github.sha }}
        run: |
          if [[ -z "${CODACY_API_TOKEN:-}" ]]; then
            echo "CODACY_API_TOKEN missing; skipping upload (coverage artifacts still generated)."
            exit 0
          fi

          common_args=(
            -a "$CODACY_API_TOKEN"
            --organization-provider "$CODACY_ORGANIZATION_PROVIDER"
            -u "$CODACY_USERNAME"
            -p "$CODACY_PROJECT_NAME"
            --commit-uuid "$CODACY_COMMIT_UUID"
          )

          bash <(curl -Ls https://coverage.codacy.com/get.sh) report \
            "${common_args[@]}" \
            -r clients/go/coverage.out \
            -r clients/rust/lcov.info \
            --partial
          bash <(curl -Ls https://coverage.codacy.com/get.sh) final \
            "${common_args[@]}"
