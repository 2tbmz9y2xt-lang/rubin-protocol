name: codacy-coverage
on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Cache OpenSSL 3.5 bundle
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/rubin-openssl/bundle-3.5.5
            ~/.cache/rubin-openssl/work/openssl-3.5.5.tar.gz
          key: openssl-bundle-${{ runner.os }}-3.5.5-v2

      - name: Build OpenSSL 3.5.5 bundle (PQC-enabled)
        run: |
          set -euo pipefail
          PREFIX="$HOME/.cache/rubin-openssl/bundle-3.5.5"
          MODULES_DIR="$PREFIX/lib/ossl-modules"
          if [ ! -d "$MODULES_DIR" ] && [ -d "$PREFIX/lib64/ossl-modules" ]; then
            MODULES_DIR="$PREFIX/lib64/ossl-modules"
          fi
          if [ ! -x "$PREFIX/bin/openssl" ] || [ ! -f "$PREFIX/ssl/openssl-fips.cnf" ] || [ ! -d "$MODULES_DIR" ]; then
            OPENSSL_VERSION=3.5.5 PREFIX="$PREFIX" bash scripts/crypto/openssl/build-openssl-bundle.sh
          fi
          if [ -d "$PREFIX/lib/ossl-modules" ]; then
            MODULES_DIR="$PREFIX/lib/ossl-modules"
          elif [ -d "$PREFIX/lib64/ossl-modules" ]; then
            MODULES_DIR="$PREFIX/lib64/ossl-modules"
          else
            echo "ERROR: OpenSSL modules directory not found under $PREFIX/lib*/ossl-modules" >&2
            exit 1
          fi
          echo "$PREFIX/bin" >> "$GITHUB_PATH"
          echo "OPENSSL_DIR=$PREFIX" >> "$GITHUB_ENV"
          echo "PKG_CONFIG_PATH=$PREFIX/lib64/pkgconfig:$PREFIX/lib/pkgconfig" >> "$GITHUB_ENV"
          echo "LD_LIBRARY_PATH=$PREFIX/lib64:$PREFIX/lib" >> "$GITHUB_ENV"
          echo "OPENSSL_MODULES=$MODULES_DIR" >> "$GITHUB_ENV"
          echo "OPENSSL_CONF=$PREFIX/ssl/openssl-fips.cnf" >> "$GITHUB_ENV"

      - name: Verify OpenSSL PQ algorithms
        run: |
          openssl version
          openssl list -signature-algorithms | grep -E 'ML-DSA-87|SLH-DSA-SHAKE-256f'

      - uses: actions/setup-go@v5
        with:
          go-version: '1.24.13'
          cache: true
          cache-dependency-path: clients/go/go.mod

      - uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust deps (coverage)
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            clients/rust/target
          key: rust-coverage-${{ runner.os }}-${{ hashFiles('clients/rust/Cargo.lock') }}
          restore-keys: |
            rust-coverage-${{ runner.os }}-

      - name: Install cargo-tarpaulin (prebuilt)
        env:
          TARPAULIN_VERSION: 0.35.2
        run: |
          set -euo pipefail
          mkdir -p "$HOME/.cargo/bin"
          curl -sL "https://github.com/xd009642/tarpaulin/releases/download/${TARPAULIN_VERSION}/cargo-tarpaulin-x86_64-unknown-linux-musl.tar.gz" \
            | tar xz -C "$HOME/.cargo/bin"
          echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"
          cargo tarpaulin --version

      - name: Go coverage
        run: |
          cd clients/go
          # Coverage gating focuses on consensus/runtime libraries.
          # Large CLI entrypoints (especially rubin-consensus-cli) are intentionally excluded
          # until they have dedicated tests.
          pkgs="$(go list ./... | grep -v '/cmd/rubin-consensus-cli$')"
          go test -coverprofile=coverage.out ${pkgs}

      - name: Rust coverage
        run: |
          cd clients/rust
          # Exclude CLI-heavy packages from coverage gating until they have dedicated tests.
          cargo tarpaulin --workspace \
            --exclude rubin-consensus-cli \
            --exclude-files crates/rubin-node/src/* \
            --exclude-files crates/rubin-consensus-cli/src/* \
            --out Lcov \
            --output-dir .

      - name: Upload to Codacy
        env:
          CODACY_API_TOKEN: ${{ secrets.CODACY_API_TOKEN }}
          CODACY_ORGANIZATION_PROVIDER: gh
          CODACY_USERNAME: ${{ github.repository_owner }}
          CODACY_PROJECT_NAME: rubin-protocol
          CODACY_COMMIT_UUID: ${{ github.event.pull_request.head.sha || github.sha }}
        run: |
          if [[ -z "${CODACY_API_TOKEN:-}" ]]; then
            echo "CODACY_API_TOKEN missing; skipping upload (coverage artifacts still generated)."
            exit 0
          fi

          common_args=(
            -a "$CODACY_API_TOKEN"
            --organization-provider "$CODACY_ORGANIZATION_PROVIDER"
            -u "$CODACY_USERNAME"
            -p "$CODACY_PROJECT_NAME"
            --commit-uuid "$CODACY_COMMIT_UUID"
          )

          codacy_missing_repo_ok() {
            # When a repo has moved orgs, Codacy may not be configured yet for the new slug.
            # Treat "repository not found" as non-blocking so CI stays green while integration is being set up.
            grep -qiE 'could not find repository|repository[[:space:]]+not[[:space:]]+found' "$1"
          }

          # Upload Go and Rust coverage separately: Codacy auto-detects Go coverage.out as LCOV
          # unless we force the correct parser.
          set +e
          bash <(curl -Ls https://coverage.codacy.com/get.sh) report \
            "${common_args[@]}" \
            -r clients/go/coverage.out \
            --force-coverage-parser go \
            --partial 2>&1 | tee /tmp/codacy_report_go.log
          rc="${PIPESTATUS[0]}"
          set -e
          if [[ "$rc" != "0" ]]; then
            if codacy_missing_repo_ok /tmp/codacy_report_go.log; then
              echo "Codacy repo not found for ${CODACY_USERNAME}/${CODACY_PROJECT_NAME}; skipping upload."
              exit 0
            fi
            echo "Codacy upload failed (non-blocking). See /tmp/codacy_report_go.log for details."
            exit 0
          fi

          set +e
          bash <(curl -Ls https://coverage.codacy.com/get.sh) report \
            "${common_args[@]}" \
            -r clients/rust/lcov.info \
            --force-coverage-parser lcov \
            --partial 2>&1 | tee /tmp/codacy_report_rust.log
          rc="${PIPESTATUS[0]}"
          set -e
          if [[ "$rc" != "0" ]]; then
            if codacy_missing_repo_ok /tmp/codacy_report_rust.log; then
              echo "Codacy repo not found for ${CODACY_USERNAME}/${CODACY_PROJECT_NAME}; skipping upload."
              exit 0
            fi
            echo "Codacy upload failed (non-blocking). See /tmp/codacy_report_rust.log for details."
            exit 0
          fi

          set +e
          bash <(curl -Ls https://coverage.codacy.com/get.sh) final \
            "${common_args[@]}" 2>&1 | tee /tmp/codacy_final.log
          rc="${PIPESTATUS[0]}"
          set -e
          if [[ "$rc" != "0" ]]; then
            if codacy_missing_repo_ok /tmp/codacy_final.log; then
              echo "Codacy repo not found for ${CODACY_USERNAME}/${CODACY_PROJECT_NAME}; skipping finalization."
              exit 0
            fi
            echo "Codacy finalization failed (non-blocking). See /tmp/codacy_final.log for details."
            exit 0
          fi
