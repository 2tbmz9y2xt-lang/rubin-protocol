name: ci
on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  policy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Sensitive files/content gate
        run: python3 tools/check_sensitive_files.py

  security_ai:
    needs: policy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.24.13'
          cache: true
          cache-dependency-path: clients/go/go.mod

      - uses: dtolnay/rust-toolchain@stable

      - name: Install Semgrep
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install semgrep

      - name: Install gosec + govulncheck
        run: |
          go install github.com/securego/gosec/v2/cmd/gosec@latest
          go install golang.org/x/vuln/cmd/govulncheck@latest
          echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked

      - name: Security precheck gate
        run: scripts/security/precheck.sh --ci

  formal:
    needs: policy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install elan (Lean toolchain manager)
        run: |
          curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y
          echo "$HOME/.elan/bin" >> "$GITHUB_PATH"

      - name: Lean build (rubin-formal)
        run: |
          cd rubin-formal
          lake env lean --version
          lake build

      - name: Formal coverage baseline check
        run: python3 tools/check_formal_coverage.py

      - name: Formal refinement bridge check
        run: python3 tools/check_formal_refinement_bridge.py

      - name: Formal claims lint
        run: python3 tools/check_formal_claims_lint.py

      - name: Formal risk gate (Phase-0/devnet)
        run: python3 tools/check_formal_risk_gate.py --profile phase0

  test:
    needs: policy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Cache OpenSSL 3.5 bundle
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/rubin-openssl/bundle-3.5.5
            ~/.cache/rubin-openssl/work/openssl-3.5.5.tar.gz
          key: openssl-bundle-${{ runner.os }}-3.5.5-v2

      - name: Build OpenSSL 3.5.5 bundle
        run: |
          set -euo pipefail
          PREFIX="$HOME/.cache/rubin-openssl/bundle-3.5.5"
          MODULES_DIR="$PREFIX/lib/ossl-modules"
          if [ ! -d "$MODULES_DIR" ] && [ -d "$PREFIX/lib64/ossl-modules" ]; then
            MODULES_DIR="$PREFIX/lib64/ossl-modules"
          fi
          if [ ! -x "$PREFIX/bin/openssl" ] || [ ! -f "$PREFIX/ssl/openssl-fips.cnf" ] || [ ! -d "$MODULES_DIR" ]; then
            OPENSSL_VERSION=3.5.5 PREFIX="$PREFIX" bash scripts/crypto/openssl/build-openssl-bundle.sh
          fi
          if [ -d "$PREFIX/lib/ossl-modules" ]; then
            MODULES_DIR="$PREFIX/lib/ossl-modules"
          elif [ -d "$PREFIX/lib64/ossl-modules" ]; then
            MODULES_DIR="$PREFIX/lib64/ossl-modules"
          else
            echo "ERROR: OpenSSL modules directory not found under $PREFIX/lib*/ossl-modules" >&2
            exit 1
          fi
          echo "$PREFIX/bin" >> "$GITHUB_PATH"
          echo "OPENSSL_DIR=$PREFIX" >> "$GITHUB_ENV"
          echo "PKG_CONFIG_PATH=$PREFIX/lib64/pkgconfig:$PREFIX/lib/pkgconfig" >> "$GITHUB_ENV"
          echo "LD_LIBRARY_PATH=$PREFIX/lib64:$PREFIX/lib" >> "$GITHUB_ENV"
          echo "OPENSSL_MODULES=$MODULES_DIR" >> "$GITHUB_ENV"
          echo "OPENSSL_CONF=$PREFIX/ssl/openssl-fips.cnf" >> "$GITHUB_ENV"

      - name: Verify OpenSSL PQ algorithms
        run: |
          openssl version
          openssl list -signature-algorithms | grep -E 'ML-DSA-87|SLH-DSA-SHAKE-256f'

      - name: FIPS provider preflight (module + PQ visibility)
        env:
          RUBIN_OPENSSL_PREFIX: ${{ env.OPENSSL_DIR }}
          RUBIN_OPENSSL_MODULES: ${{ env.OPENSSL_MODULES }}
          RUBIN_OPENSSL_CONF: ${{ env.OPENSSL_CONF }}
          RUBIN_OPENSSL_FIPS_MODE: only
        run: |
          scripts/dev-env.sh -- scripts/crypto/openssl/fips-preflight.sh

      - uses: actions/setup-go@v5
        with:
          go-version: '1.24.13'
          cache: true
          cache-dependency-path: clients/go/go.mod
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - uses: actions/setup-node@v4
        with:
          node-version-file: '.node-version'

      - name: Strict JSON parse (tracked)
        run: |
          python3 - <<'PY'
          import json, subprocess, sys
          from pathlib import Path
          
          def reject_const(x: str):
            raise ValueError(f"non-standard JSON constant not allowed: {x}")
          
          tracked = subprocess.check_output(["git", "ls-files", "*.json"], text=True).splitlines()
          paths = [Path(p) for p in tracked if p.strip()]
          if not paths:
            print("no tracked json files found")
            sys.exit(1)
          
          bad = False
          for p in paths:
            try:
              s = p.read_text(encoding="utf-8")
            except Exception as e:
              print(f"READ_FAIL {p}: {e}")
              bad = True
              continue
            try:
              v = json.loads(s, parse_constant=reject_const)
            except Exception as e:
              print(f"PARSE_FAIL {p}: {e}")
              bad = True
              continue
            if not isinstance(v, (dict, list)):
              print(f"ROOT_FAIL {p}: root must be object or array")
              bad = True
          
          if bad:
            sys.exit(1)
          print(f"ok: {len(paths)} files")
          PY

      - name: Go fmt
        run: |
          cd clients/go
          test -z "$(gofmt -l .)"

      - name: Go tests
        run: |
          cd clients/go
          go test ./...

      - name: Go vet
        run: |
          cd clients/go
          go vet ./...

      - name: Go govulncheck
        run: |
          cd clients/go
          go install golang.org/x/vuln/cmd/govulncheck@latest
          "$(go env GOPATH)/bin/govulncheck" ./...

      - name: Rust fmt
        run: |
          cd clients/rust
          cargo fmt -- --check

      - name: Rust tests
        run: |
          cd clients/rust
          cargo test --workspace

      - name: Rust clippy
        run: |
          cd clients/rust
          cargo clippy --workspace --all-targets -- -D warnings

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked

      - name: Cargo audit
        run: |
          cd clients/rust
          cargo audit --deny warnings

      - name: Conformance matrix check
        run: python3 tools/gen_conformance_matrix.py --check

      - name: Conformance fixtures policy check
        run: python3 tools/check_conformance_fixtures_policy.py

      - name: Conformance bundle
        run: |
          python3 conformance/runner/run_cv_bundle.py

  formal_refinement:
    needs: policy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install elan (Lean toolchain manager)
        run: |
          curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y
          echo "$HOME/.elan/bin" >> "$GITHUB_PATH"

      - name: Cache OpenSSL 3.5 bundle
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/rubin-openssl/bundle-3.5.5
            ~/.cache/rubin-openssl/work/openssl-3.5.5.tar.gz
          key: openssl-bundle-${{ runner.os }}-3.5.5-v2

      - name: Build OpenSSL 3.5.5 bundle
        id: openssl
        run: |
          set -euo pipefail
          PREFIX="$HOME/.cache/rubin-openssl/bundle-3.5.5"
          MODULES_DIR="$PREFIX/lib/ossl-modules"
          if [ ! -d "$MODULES_DIR" ] && [ -d "$PREFIX/lib64/ossl-modules" ]; then
            MODULES_DIR="$PREFIX/lib64/ossl-modules"
          fi
          if [ ! -x "$PREFIX/bin/openssl" ] || [ ! -f "$PREFIX/ssl/openssl-fips.cnf" ] || [ ! -d "$MODULES_DIR" ]; then
            OPENSSL_VERSION=3.5.5 PREFIX="$PREFIX" bash scripts/crypto/openssl/build-openssl-bundle.sh
          fi
          if [ -d "$PREFIX/lib/ossl-modules" ]; then
            MODULES_DIR="$PREFIX/lib/ossl-modules"
          elif [ -d "$PREFIX/lib64/ossl-modules" ]; then
            MODULES_DIR="$PREFIX/lib64/ossl-modules"
          else
            echo "ERROR: OpenSSL modules directory not found under $PREFIX/lib*/ossl-modules" >&2
            exit 1
          fi
          echo "$PREFIX/bin" >> "$GITHUB_PATH"
          echo "openssl_dir=$PREFIX" >> "$GITHUB_OUTPUT"
          echo "openssl_modules=$MODULES_DIR" >> "$GITHUB_OUTPUT"
          echo "openssl_conf=$PREFIX/ssl/openssl-fips.cnf" >> "$GITHUB_OUTPUT"
          echo "pkg_config_path=$PREFIX/lib64/pkgconfig:$PREFIX/lib/pkgconfig" >> "$GITHUB_OUTPUT"
          echo "ld_library_path=$PREFIX/lib64:$PREFIX/lib" >> "$GITHUB_OUTPUT"

      - name: Verify OpenSSL PQ algorithms
        env:
          OPENSSL_DIR: ${{ steps.openssl.outputs.openssl_dir }}
          OPENSSL_MODULES: ${{ steps.openssl.outputs.openssl_modules }}
          OPENSSL_CONF: ${{ steps.openssl.outputs.openssl_conf }}
          PKG_CONFIG_PATH: ${{ steps.openssl.outputs.pkg_config_path }}
          LD_LIBRARY_PATH: ${{ steps.openssl.outputs.ld_library_path }}
        run: |
          openssl version
          openssl list -signature-algorithms | grep -E 'ML-DSA-87|SLH-DSA-SHAKE-256f'

      - uses: actions/setup-go@v5
        with:
          go-version: '1.24.13'
          cache: true
          cache-dependency-path: clients/go/go.mod

      - name: Generate Go trace v1
        env:
          OPENSSL_DIR: ${{ steps.openssl.outputs.openssl_dir }}
          OPENSSL_MODULES: ${{ steps.openssl.outputs.openssl_modules }}
          OPENSSL_CONF: ${{ steps.openssl.outputs.openssl_conf }}
          PKG_CONFIG_PATH: ${{ steps.openssl.outputs.pkg_config_path }}
          LD_LIBRARY_PATH: ${{ steps.openssl.outputs.ld_library_path }}
        run: |
          cd clients/go
          go run ./cmd/formal-trace --fixtures-dir ../../conformance/fixtures --out ../../rubin-formal/traces/go_trace_v1.jsonl

      - name: Generate Lean expected outputs (GoTraceV1.lean)
        run: |
          python3 tools/formal/gen_lean_refinement_from_traces.py --traces rubin-formal/traces/go_trace_v1.jsonl --out rubin-formal/RubinFormal/Refinement/GoTraceV1.lean
          git diff --exit-code -- rubin-formal/RubinFormal/Refinement/GoTraceV1.lean

      - name: Lean build (rubin-formal)
        run: |
          cd rubin-formal
          lake env lean --version
          lake build

      - name: Run Goâ†’Lean refinement check
        run: |
          cd rubin-formal
          lake env lean --run RubinFormal/Refinement/Main.lean

  codacy_coverage:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.24.13'
          cache: true
          cache-dependency-path: clients/go/go.mod

      - uses: dtolnay/rust-toolchain@stable

      - name: Generate Go coverage
        run: |
          cd clients/go
          go test -coverprofile=coverage.out ./...

      - name: Install cargo-tarpaulin
        run: cargo install cargo-tarpaulin --locked

      - name: Generate Rust LCOV coverage
        run: |
          cd clients/rust
          cargo tarpaulin --out Lcov --output-dir .

      - name: Upload coverage reports to Codacy
        env:
          CODACY_API_TOKEN: ${{ secrets.CODACY_API_TOKEN }}
          CODACY_ORGANIZATION_PROVIDER: gh
          CODACY_USERNAME: 2tbmz9y2xt-lang
          CODACY_PROJECT_NAME: rubin-protocol
        run: |
          if [ -z "${CODACY_API_TOKEN:-}" ]; then
            echo "Skipping Codacy upload: CODACY_API_TOKEN is not configured."
            exit 0
          fi
          bash <(curl -Ls https://coverage.codacy.com/get.sh) report \
            -r clients/go/coverage.out \
            --force-coverage-parser go \
            --partial \
            --commit-uuid "${GITHUB_SHA}"
          bash <(curl -Ls https://coverage.codacy.com/get.sh) report \
            -r clients/rust/lcov.info \
            --partial \
            --commit-uuid "${GITHUB_SHA}"
          bash <(curl -Ls https://coverage.codacy.com/get.sh) final \
            --commit-uuid "${GITHUB_SHA}"

  validator:
    name: validator
    needs: [policy, security_ai, formal, test, formal_refinement, codacy_coverage]
    if: ${{ always() }}
    runs-on: ubuntu-latest
    steps:
      - name: Enforce validator-gate dependencies
        run: |
          declare -A results=(
            [policy]="${{ needs.policy.result }}"
            [security_ai]="${{ needs.security_ai.result }}"
            [formal]="${{ needs.formal.result }}"
            [test]="${{ needs.test.result }}"
            [formal_refinement]="${{ needs.formal_refinement.result }}"
            [codacy_coverage]="${{ needs.codacy_coverage.result }}"
          )
          failed=0
          for key in policy security_ai formal test formal_refinement codacy_coverage; do
            value="${results[$key]}"
            echo "$key=$value"
            if [ "$value" != "success" ]; then
              failed=1
            fi
          done
          if [ "$failed" -ne 0 ]; then
            echo "validator gate failed: one or more prerequisite jobs did not succeed" >&2
            exit 1
          fi
          echo "validator gate passed"
