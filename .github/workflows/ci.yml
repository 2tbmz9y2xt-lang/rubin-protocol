name: ci
on:
  push:
  pull_request:

jobs:
  formal:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install elan (Lean toolchain manager)
        run: |
          curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y
          echo "$HOME/.elan/bin" >> "$GITHUB_PATH"

      - name: Lean build (rubin-formal)
        run: |
          cd rubin-formal
          lake env lean --version
          lake build

      - name: Formal coverage baseline check
        run: python3 tools/check_formal_coverage.py

      - name: Formal risk gate (Phase-0/devnet)
        run: python3 tools/check_formal_risk_gate.py --profile phase0

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24.13'
          cache: true
          cache-dependency-path: clients/go/go.mod
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - uses: actions/setup-node@v4
        with:
          node-version-file: '.node-version'

      - name: Strict JSON parse (tracked)
        run: |
          python3 - <<'PY'
          import json, subprocess, sys
          from pathlib import Path
          
          def reject_const(x: str):
            raise ValueError(f"non-standard JSON constant not allowed: {x}")
          
          tracked = subprocess.check_output(["git", "ls-files", "*.json"], text=True).splitlines()
          paths = [Path(p) for p in tracked if p.strip()]
          if not paths:
            print("no tracked json files found")
            sys.exit(1)
          
          bad = False
          for p in paths:
            try:
              s = p.read_text(encoding="utf-8")
            except Exception as e:
              print(f"READ_FAIL {p}: {e}")
              bad = True
              continue
            try:
              v = json.loads(s, parse_constant=reject_const)
            except Exception as e:
              print(f"PARSE_FAIL {p}: {e}")
              bad = True
              continue
            if not isinstance(v, (dict, list)):
              print(f"ROOT_FAIL {p}: root must be object or array")
              bad = True
          
          if bad:
            sys.exit(1)
          print(f"ok: {len(paths)} files")
          PY

      - name: Go fmt
        run: |
          cd clients/go
          test -z "$(gofmt -l .)"

      - name: Go tests
        run: |
          cd clients/go
          go test ./...

      - name: Go vet
        run: |
          cd clients/go
          go vet ./...

      - name: Go govulncheck
        run: |
          cd clients/go
          go install golang.org/x/vuln/cmd/govulncheck@latest
          "$(go env GOPATH)/bin/govulncheck" ./...

      - name: Rust fmt
        run: |
          cd clients/rust
          cargo fmt -- --check

      - name: Rust tests
        run: |
          cd clients/rust
          cargo test --workspace

      - name: Rust clippy
        run: |
          cd clients/rust
          cargo clippy --workspace --all-targets -- -D warnings

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked

      - name: Cargo audit
        run: |
          cd clients/rust
          cargo audit --deny warnings

      - name: Spec invariants check
        run: node scripts/check-spec-invariants.mjs

      - name: Spec section hashes check
        run: node scripts/check-section-hashes.mjs

      - name: Crypto backend policy check
        run: python3 tools/check_crypto_backend_policy.py

      - name: Conformance matrix check
        run: python3 tools/gen_conformance_matrix.py --check

      - name: Conformance fixtures policy check
        run: python3 tools/check_conformance_fixtures_policy.py

      - name: Conformance bundle
        run: |
          python3 conformance/runner/run_cv_bundle.py
