name: CodeRabbit Auto Review

on:
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review]

permissions:
  pull-requests: write
  contents: read

concurrency:
  group: coderabbit-autoreview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  request-review:
    if: ${{ github.event.pull_request.draft == false }}
    runs-on: ubuntu-latest
    steps:
      - name: Request CodeRabbit review (idempotent)
        uses: actions/github-script@v8
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.pull_request.number;
            const marker = '@coderabbitai review';

            // Avoid spamming: only post once per PR, by this workflow.
            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number,
              per_page: 100,
            });

            const already = comments.some(c =>
              c.user?.login === 'github-actions[bot]' &&
              typeof c.body === 'string' &&
              c.body.includes(marker)
            );

            if (already) {
              core.info('Marker comment already present; skipping.');
              return;
            }

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body: marker,
            });
            core.info('Posted CodeRabbit review request marker.');

