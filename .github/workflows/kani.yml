# Kani bounded model checking for Rust consensus library.
#
# Runs all #[kani::proof] harnesses in clients/rust/crates/rubin-consensus.
# Kani verifies properties for ALL possible inputs within the specified bound,
# providing mathematical guarantees that complement Lean4 formal proofs.
#
# SAT-intractable harnesses are excluded:
#   - SHA3 (Keccak-f[1600] 24-round permutation)
#   - BigUint (arbitrary-precision arithmetic via Vec<u32>)
# Remaining harnesses (compactsize, subsidy, merkle-empty, tx-header, block-weight)
# solve in seconds on GitHub Actions runners.
name: Kani Verification

on:
  push:
    branches: [main]
    paths:
      - 'clients/rust/**'
  pull_request:
    paths:
      - 'clients/rust/**'
  schedule:
    # Weekly: Wednesday 04:00 UTC â€” catches regressions from Kani updates.
    - cron: '0 4 * * 3'

jobs:
  kani:
    name: Kani Proof Check
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v6

      # OpenSSL dev headers required to compile openssl-sys FFI crate.
      # Kani proofs only exercise pure-Rust logic, but the crate must compile.
      - name: Install OpenSSL dev headers
        run: sudo apt-get update && sudo apt-get install -y libssl-dev pkg-config

      # Cache Kani toolchain to avoid re-downloading CBMC (~200 MB) every run.
      - name: Cache Kani toolchain
        uses: actions/cache@v5
        with:
          path: ~/.kani
          key: kani-toolchain-${{ runner.os }}-${{ hashFiles('.github/workflows/kani.yml') }}

      # Cache Cargo build artifacts for faster recompilation.
      - name: Cache Cargo registry + target
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            clients/rust/crates/rubin-consensus/target
          key: kani-cargo-${{ runner.os }}-${{ hashFiles('clients/rust/crates/rubin-consensus/Cargo.toml') }}

      - uses: model-checking/kani-github-action@v1.1
        with:
          working-directory: clients/rust/crates/rubin-consensus
          args: '--output-format=terse'
