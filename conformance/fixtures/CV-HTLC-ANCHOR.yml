version: "1.1"
gate: CV-HTLC-ANCHOR
status: PASS
description: "CORE_HTLC_V2: redeem via CORE_ANCHOR envelope (prefix+len), refund via timelock, deterministic errors"
tests:
  - id: HTLC2-01
    title: "Redeem FAIL: missing CORE_ANCHOR output => TX_ERR_PARSE"
    context:
      chain_id_hex: "7dcf48a266788491e77bbb7b9c97ad6a2c89b882293dfaf3bdebeec62548cc00"
      chain_height: 600
      chain_timestamp: 1700000600
      suite_id_02_active: true
      htlc_v2_active: true
      tx_hex: "0100000001000000000000000103030303030303030303030303030303030303030303030303030303030303030000000000000000000000000000010240000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100"
      utxo_set:
        - txid: "0303030303030303030303030303030303030303030303030303030303030303"
          vout: 0
          value: 1000
          covenant_type: 258
          covenant_data: "e2929f80ffdaaa51c427cbf42df6679013fddb1630bc28f234ca48692b35399200f401000000000000070fa1ab6fcc557ed14d42941f1967693048551eb9042a8d0a057afbd75e81e03333333333333333333333333333333333333333333333333333333333333333"
    expected_error: TX_ERR_PARSE
    consensus: true

  - id: HTLC2-02
    title: "Redeem FAIL: CORE_ANCHOR wrong prefix => TX_ERR_PARSE"
    context:
      chain_id_hex: "7dcf48a266788491e77bbb7b9c97ad6a2c89b882293dfaf3bdebeec62548cc00"
      chain_height: 600
      chain_timestamp: 1700000600
      suite_id_02_active: true
      htlc_v2_active: true
      tx_hex: "010000000100000000000000010303030303030303030303030303030303030303030303030303030303030303000000000000000000010000000000000000020036525542494e76312d68746c632d707265696d6167652e111111111111111111111111111111111111111111111111111111111111111100000000010240000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100"
      utxo_set:
        - txid: "0303030303030303030303030303030303030303030303030303030303030303"
          vout: 0
          value: 1000
          covenant_type: 258
          covenant_data: "e2929f80ffdaaa51c427cbf42df6679013fddb1630bc28f234ca48692b35399200f401000000000000070fa1ab6fcc557ed14d42941f1967693048551eb9042a8d0a057afbd75e81e03333333333333333333333333333333333333333333333333333333333333333"
    expected_error: TX_ERR_PARSE
    consensus: true

  - id: HTLC2-03
    title: "Redeem FAIL: CORE_ANCHOR wrong total length (53 != 54) => TX_ERR_PARSE"
    context:
      chain_id_hex: "7dcf48a266788491e77bbb7b9c97ad6a2c89b882293dfaf3bdebeec62548cc00"
      chain_height: 600
      chain_timestamp: 1700000600
      suite_id_02_active: true
      htlc_v2_active: true
      tx_hex: "010000000100000000000000010303030303030303030303030303030303030303030303030303030303030303000000000000000000010000000000000000020035525542494e76312d68746c632d707265696d6167652f1111111111111111111111111111111111111111111111111111111111111100000000010240000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100"
      utxo_set:
        - txid: "0303030303030303030303030303030303030303030303030303030303030303"
          vout: 0
          value: 1000
          covenant_type: 258
          covenant_data: "e2929f80ffdaaa51c427cbf42df6679013fddb1630bc28f234ca48692b35399200f401000000000000070fa1ab6fcc557ed14d42941f1967693048551eb9042a8d0a057afbd75e81e03333333333333333333333333333333333333333333333333333333333333333"
    expected_error: TX_ERR_PARSE
    consensus: true

  - id: HTLC2-04
    title: "Redeem reaches signature: envelope OK + hash OK but signature invalid => TX_ERR_SIG_INVALID"
    context:
      chain_id_hex: "7dcf48a266788491e77bbb7b9c97ad6a2c89b882293dfaf3bdebeec62548cc00"
      chain_height: 600
      chain_timestamp: 1700000600
      suite_id_02_active: true
      htlc_v2_active: true
      tx_hex: "010000000100000000000000010303030303030303030303030303030303030303030303030303030303030303000000000000000000010000000000000000020036525542494e76312d68746c632d707265696d6167652f111111111111111111111111111111111111111111111111111111111111111100000000010240000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100"
      utxo_set:
        - txid: "0303030303030303030303030303030303030303030303030303030303030303"
          vout: 0
          value: 1000
          covenant_type: 258
          covenant_data: "e2929f80ffdaaa51c427cbf42df6679013fddb1630bc28f234ca48692b35399200f401000000000000070fa1ab6fcc557ed14d42941f1967693048551eb9042a8d0a057afbd75e81e03333333333333333333333333333333333333333333333333333333333333333"
    expected_error: TX_ERR_SIG_INVALID
    consensus: true

  - id: HTLC2-05
    title: "Refund FAIL: key_id == refund_key_id but height < lock_value => TX_ERR_TIMELOCK_NOT_MET"
    context:
      chain_id_hex: "7dcf48a266788491e77bbb7b9c97ad6a2c89b882293dfaf3bdebeec62548cc00"
      chain_height: 499
      chain_timestamp: 1700000499
      suite_id_02_active: true
      htlc_v2_active: true
      tx_hex: "0100000001000000000000000103030303030303030303030303030303030303030303030303030303030303030000000000000000000000000000010240000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100"
      utxo_set:
        - txid: "0303030303030303030303030303030303030303030303030303030303030303"
          vout: 0
          value: 1000
          covenant_type: 258
          covenant_data: "e2929f80ffdaaa51c427cbf42df6679013fddb1630bc28f234ca48692b35399200f4010000000000002222222222222222222222222222222222222222222222222222222222222222070fa1ab6fcc557ed14d42941f1967693048551eb9042a8d0a057afbd75e81e0"
    expected_error: TX_ERR_TIMELOCK_NOT_MET
    consensus: true

  - id: HTLC2-06
    title: "Pre-activation FAIL: spending CORE_HTLC_V2 before deployment ACTIVE => TX_ERR_DEPLOYMENT_INACTIVE"
    context:
      chain_id_hex: "7dcf48a266788491e77bbb7b9c97ad6a2c89b882293dfaf3bdebeec62548cc00"
      chain_height: 600
      chain_timestamp: 1700000600
      suite_id_02_active: true
      htlc_v2_active: false
      tx_hex: "010000000100000000000000010303030303030303030303030303030303030303030303030303030303030303000000000000000000010000000000000000020036525542494e76312d68746c632d707265696d6167652f111111111111111111111111111111111111111111111111111111111111111100000000010240000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100"
      utxo_set:
        - txid: "0303030303030303030303030303030303030303030303030303030303030303"
          vout: 0
          value: 1000
          covenant_type: 258
          covenant_data: "e2929f80ffdaaa51c427cbf42df6679013fddb1630bc28f234ca48692b35399200f401000000000000070fa1ab6fcc557ed14d42941f1967693048551eb9042a8d0a057afbd75e81e03333333333333333333333333333333333333333333333333333333333333333"
    expected_error: TX_ERR_DEPLOYMENT_INACTIVE
    consensus: true

  - id: HTLC2-07
    title: "Pre-activation FAIL: creating CORE_HTLC_V2 output before deployment ACTIVE => TX_ERR_DEPLOYMENT_INACTIVE"
    context:
      chain_id_hex: "7dcf48a266788491e77bbb7b9c97ad6a2c89b882293dfaf3bdebeec62548cc00"
      chain_height: 1
      chain_timestamp: 1700000001
      suite_id_02_active: false
      htlc_v2_active: false
      tx_hex: "01000000010000000000000001040404040404040404040404040404040404040404040404040404040404040400000000000000000001e803000000000000020169e2929f80ffdaaa51c427cbf42df6679013fddb1630bc28f234ca48692b35399200f401000000000000aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaabbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb0000000001000000"
      utxo_set:
        - txid: "0404040404040404040404040404040404040404040404040404040404040404"
          vout: 0
          value: 1000
          covenant_type: 1
          covenant_data: "000000000000000000"
    expected_error: TX_ERR_DEPLOYMENT_INACTIVE
    consensus: true

  - id: HTLC2-08
    title: "Redeem reaches signature: extra non-matching CORE_ANCHOR present => still TX_ERR_SIG_INVALID (prefix-scoped matching)"
    context:
      chain_id_hex: "7dcf48a266788491e77bbb7b9c97ad6a2c89b882293dfaf3bdebeec62548cc00"
      chain_height: 600
      chain_timestamp: 1700000600
      suite_id_02_active: true
      htlc_v2_active: true
      tx_hex: "010000000100000000000000010303030303030303030303030303030303030303030303030303030303030303000000000000000000020000000000000000020036525542494e76312d68746c632d707265696d6167652f111111111111111111111111111111111111111111111111111111111111111100000000000000000200040102030400000000010240000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100"
      utxo_set:
        - txid: "0303030303030303030303030303030303030303030303030303030303030303"
          vout: 0
          value: 1000
          covenant_type: 258
          covenant_data: "e2929f80ffdaaa51c427cbf42df6679013fddb1630bc28f234ca48692b35399200f401000000000000070fa1ab6fcc557ed14d42941f1967693048551eb9042a8d0a057afbd75e81e03333333333333333333333333333333333333333333333333333333333333333"
    expected_error: TX_ERR_SIG_INVALID
    consensus: true

  - id: HTLC2-09
    title: "Redeem FAIL: two matching HTLC envelope anchors => TX_ERR_PARSE (deterministic)"
    context:
      chain_id_hex: "7dcf48a266788491e77bbb7b9c97ad6a2c89b882293dfaf3bdebeec62548cc00"
      chain_height: 600
      chain_timestamp: 1700000600
      suite_id_02_active: true
      htlc_v2_active: true
      tx_hex: "010000000100000000000000010303030303030303030303030303030303030303030303030303030303030303000000000000000000020000000000000000020036525542494e76312d68746c632d707265696d6167652f11111111111111111111111111111111111111111111111111111111111111110000000000000000020036525542494e76312d68746c632d707265696d6167652f111111111111111111111111111111111111111111111111111111111111111100000000010240000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100"
      utxo_set:
        - txid: "0303030303030303030303030303030303030303030303030303030303030303"
          vout: 0
          value: 1000
          covenant_type: 258
          covenant_data: "e2929f80ffdaaa51c427cbf42df6679013fddb1630bc28f234ca48692b35399200f401000000000000070fa1ab6fcc557ed14d42941f1967693048551eb9042a8d0a057afbd75e81e03333333333333333333333333333333333333333333333333333333333333333"
    expected_error: TX_ERR_PARSE
    consensus: true

  - id: HTLC2-10
    title: "Redeem PASS: multiple non-HTLC ANCHOR outputs present, exactly one matching envelope => prefix-scoped claim (multi-app tx)"
    kind: consensus
    consensus: true
    description: >
      The original Q-048 bug: an old count-check would reject this tx because
      len(all_anchors) > 1. The correct prefix-check counts only anchors matching
      "RUBINv1-htlc-preimage/" (len=54). Three extra ANCHOR outputs with unrelated
      payloads must be ignored. Tx reaches signature verification and fails only
      because the test uses a dummy pubkey (TX_ERR_SIG_INVALID), not TX_ERR_PARSE.
      A real implementation with a valid claim key+sig would return PASS.
    context:
      chain_id_hex: "7dcf48a266788491e77bbb7b9c97ad6a2c89b882293dfaf3bdebeec62548cc00"
      chain_height: 600
      chain_timestamp: 1700000600
      suite_id_02_active: true
      htlc_v2_active: true
      anchor_outputs:
        - payload: "RUBINv1-htlc-preimage/<preimage32>"   # matching envelope (1)
        - payload: "RUBINv1-retl-batch/..."               # non-matching: wrong prefix
        - payload: "<arbitrary app data>"                  # non-matching: wrong len
        - payload: "RUBINv1-keymig-v1/..."                # non-matching: wrong prefix
      note: >
        tx_hex omitted — this test is spec-narrative only.
        See HTLC2-08 for a fully-encoded equivalent with one non-matching anchor.
        Implementations MUST pass HTLC2-08 as the authoritative binary test.
    expected_error: TX_ERR_SIG_INVALID
    spec_ref: "CANONICAL §4.1 item 6 — matching set filtered by prefix+len"
    closes: Q-048
