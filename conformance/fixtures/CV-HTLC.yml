version: "1.1"
gate: CV-HTLC
status: PASS
description: "CORE_HTLC_V1: covenant parsing hardening, sentinel rejection, deterministic timelock errors, and batching-friendly semantics (apply-utxo)"
tests:
  - id: HTLC-01
    title: "Refund FAIL: timelock not met => TX_ERR_TIMELOCK_NOT_MET (pre-signature)"
    context:
      chain_id_hex: "7dcf48a266788491e77bbb7b9c97ad6a2c89b882293dfaf3bdebeec62548cc00"
      chain_height: 499
      chain_timestamp: 1700000499
      suite_id_02_active: true
      tx_hex: "02000000000100000000000000010101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000001024000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000"
      utxo_set:
        - txid: "0101010101010101010101010101010101010101010101010101010101010101"
          vout: 0
          value: 1000
          covenant_type: 256
          covenant_data: "e2929f80ffdaaa51c427cbf42df6679013fddb1630bc28f234ca48692b35399200f4010000000000002222222222222222222222222222222222222222222222222222222222222222070fa1ab6fcc557ed14d42941f1967693048551eb9042a8d0a057afbd75e81e0"
    expected_error: TX_ERR_TIMELOCK_NOT_MET
    consensus: true

  - id: HTLC-02
    title: "Claim path reaches signature: correct preimage+key_id but signature invalid => TX_ERR_SIG_INVALID"
    context:
      chain_id_hex: "7dcf48a266788491e77bbb7b9c97ad6a2c89b882293dfaf3bdebeec62548cc00"
      chain_height: 600
      chain_timestamp: 1700000600
      suite_id_02_active: true
      tx_hex: "020000000002000000000000000102020202020202020202020202020202020202020202020202020202020202020000000020111111111111111111111111111111111111111111111111111111111111111100000000000000000001024000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000"
      utxo_set:
        - txid: "0202020202020202020202020202020202020202020202020202020202020202"
          vout: 0
          value: 1000
          covenant_type: 256
          covenant_data: "e2929f80ffdaaa51c427cbf42df6679013fddb1630bc28f234ca48692b35399200f401000000000000070fa1ab6fcc557ed14d42941f1967693048551eb9042a8d0a057afbd75e81e03333333333333333333333333333333333333333333333333333333333333333"
    expected_error: TX_ERR_SIG_INVALID
    consensus: true

  - id: HTLC-03
    title: "FAIL: invalid lock_mode (0x02) => TX_ERR_PARSE"
    context:
      chain_id_hex: "7dcf48a266788491e77bbb7b9c97ad6a2c89b882293dfaf3bdebeec62548cc00"
      chain_height: 600
      chain_timestamp: 1700000600
      suite_id_02_active: true
      tx_hex: "02000000000100000000000000010101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000001024000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000"
      utxo_set:
        - txid: "0101010101010101010101010101010101010101010101010101010101010101"
          vout: 0
          value: 1000
          covenant_type: 256
          covenant_data: "e2929f80ffdaaa51c427cbf42df6679013fddb1630bc28f234ca48692b35399202f401000000000000070fa1ab6fcc557ed14d42941f1967693048551eb9042a8d0a057afbd75e81e03333333333333333333333333333333333333333333333333333333333333333"
    expected_error: TX_ERR_PARSE
    consensus: true

  - id: HTLC-04
    title: "FAIL: claim_key_id == refund_key_id => TX_ERR_PARSE"
    context:
      chain_id_hex: "7dcf48a266788491e77bbb7b9c97ad6a2c89b882293dfaf3bdebeec62548cc00"
      chain_height: 600
      chain_timestamp: 1700000600
      suite_id_02_active: true
      tx_hex: "02000000000100000000000000010101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000001024000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000"
      utxo_set:
        - txid: "0101010101010101010101010101010101010101010101010101010101010101"
          vout: 0
          value: 1000
          covenant_type: 256
          covenant_data: "e2929f80ffdaaa51c427cbf42df6679013fddb1630bc28f234ca48692b35399200f401000000000000070fa1ab6fcc557ed14d42941f1967693048551eb9042a8d0a057afbd75e81e0070fa1ab6fcc557ed14d42941f1967693048551eb9042a8d0a057afbd75e81e0"
    expected_error: TX_ERR_PARSE
    consensus: true

  - id: HTLC-05
    title: "FAIL: sentinel witness forbidden for HTLC => TX_ERR_SIG_ALG_INVALID"
    context:
      chain_id_hex: "7dcf48a266788491e77bbb7b9c97ad6a2c89b882293dfaf3bdebeec62548cc00"
      chain_height: 600
      chain_timestamp: 1700000600
      suite_id_02_active: false
      tx_hex: "0200000000010000000000000001010101010101010101010101010101010101010101010101010101010101010100000000000000000000000000000100000000"
      utxo_set:
        - txid: "0101010101010101010101010101010101010101010101010101010101010101"
          vout: 0
          value: 1000
          covenant_type: 256
          covenant_data: "e2929f80ffdaaa51c427cbf42df6679013fddb1630bc28f234ca48692b35399200f4010000000000002222222222222222222222222222222222222222222222222222222222222222070fa1ab6fcc557ed14d42941f1967693048551eb9042a8d0a057afbd75e81e0"
    expected_error: TX_ERR_SIG_ALG_INVALID
    consensus: true

  - id: HTLC-06
    title: "Batching OK: two HTLC inputs allowed; reaches signature => TX_ERR_SIG_INVALID"
    context:
      chain_id_hex: "7dcf48a266788491e77bbb7b9c97ad6a2c89b882293dfaf3bdebeec62548cc00"
      chain_height: 600
      chain_timestamp: 1700000600
      suite_id_02_active: true
      tx_hex: "0200000000010000000000000002010101010101010101010101010101010101010101010101010101010101010100000000000000000001010101010101010101010101010101010101010101010101010101010101010100000000000000000000000000020240000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100024000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000"
      utxo_set:
        - txid: "0101010101010101010101010101010101010101010101010101010101010101"
          vout: 0
          value: 1000
          covenant_type: 256
          covenant_data: "e2929f80ffdaaa51c427cbf42df6679013fddb1630bc28f234ca48692b35399200f4010000000000002222222222222222222222222222222222222222222222222222222222222222070fa1ab6fcc557ed14d42941f1967693048551eb9042a8d0a057afbd75e81e0"
        - txid: "0101010101010101010101010101010101010101010101010101010101010101"
          vout: 1
          value: 1000
          covenant_type: 256
          covenant_data: "e2929f80ffdaaa51c427cbf42df6679013fddb1630bc28f234ca48692b35399200f4010000000000002222222222222222222222222222222222222222222222222222222222222222070fa1ab6fcc557ed14d42941f1967693048551eb9042a8d0a057afbd75e81e0"
    expected_error: TX_ERR_SIG_INVALID
    consensus: true
